<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildlife Conservation Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gauge.js/1.3.7/gauge.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #0c0c14;
            color: #ffffff;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        .logo {
            font-size: 28px;
            font-weight: bold;
            margin-right: 20px;
        }
        .subtitle {
            color: #999;
            font-size: 14px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 20px;
        }
        .dashboard-card {
            background-color: #1a1a2e;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            position: relative;
            overflow: hidden;
        }
        .dashboard-card h2 {
            margin-top: 0;
            color: #fff;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
            font-size: 18px;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .gauge-container {
            text-align: center;
            margin-top: 10px;
        }
        .gauge-wrapper {
            display: inline-block;
            width: 200px;
            margin: 0 20px;
        }
        .gauge-label {
            font-size: 16px;
            margin-top: 10px;
            color: #ddd;
        }
        .gauge-value {
            font-size: 24px;
            font-weight: bold;
            margin-top: 5px;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        .stat-box {
            background-color: #252538;
            border-radius: 4px;
            padding: 10px;
            flex: 1;
            margin: 0 5px;
            text-align: center;
        }
        .stat-box .label {
            font-size: 12px;
            color: #999;
        }
        .stat-box .value {
            font-size: 20px;
            font-weight: bold;
            margin-top: 5px;
        }
        .status-normal {
            color: #4CAF50;
        }
        .status-warning {
            color: #FFC107;
        }
        .status-alert {
            color: #F44336;
        }
        .neon-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 8px;
            pointer-events: none;
            z-index: -1;
        }
        .glow-sound {
            box-shadow: inset 0 0 20px rgba(255, 0, 128, 0.3);
        }
        .glow-temp {
            box-shadow: inset 0 0 20px rgba(0, 128, 255, 0.3);
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        .alert-banner {
            background-color: rgba(244, 67, 54, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        .alert-banner.show {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .alert-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        .alert-message {
            flex-grow: 1;
        }
        .alert-timestamp {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }
        .mode-selector {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 15px;
        }
        .mode-button {
            background-color: #252538;
            border: 1px solid #444;
            color: #999;
            padding: 8px 16px;
            margin: 0 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mode-button.active {
            background-color: #501e5f;
            color: white;
            border-color: #8e44ad;
            box-shadow: 0 0 10px rgba(142, 68, 173, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">Wildlife Conservation Monitoring System</div>
            <div class="subtitle">
                • Real-time sensor analytics • Conservation tracking
            </div>
        </div>

        <div id="predatorAlert" class="alert-banner">
            <span class="alert-icon">⚠️</span>
            <span class="alert-message">Predator activity detected! Sound level exceeds threshold at 73.08 dB</span>
            <span class="alert-timestamp">Last detected: <span id="alertTime">-</span></span>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <div class="neon-glow glow-sound"></div>
                <h2>Sound Monitoring</h2>
                <div class="chart-container">
                    <canvas id="soundChart"></canvas>
                </div>
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="label">Average Sound</div>
                        <div class="value" id="avgSound">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Max Sound</div>
                        <div class="value" id="maxSound">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Human Activity</div>
                        <div class="value" id="humanActivity">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Predator Activity</div>
                        <div class="value" id="predatorActivity">-</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="neon-glow glow-temp"></div>
                <h2>Temperature Monitoring</h2>
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="label">Average Temp</div>
                        <div class="value" id="avgTemp">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Min Temp</div>
                        <div class="value" id="minTemp">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Max Temp</div>
                        <div class="value" id="maxTemp">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Frost Warnings</div>
                        <div class="value" id="frostWarnings">-</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card">
                <h2>Sound Level Gauge</h2>
                <div class="gauge-container">
                    <div class="gauge-wrapper">
                        <canvas id="soundGauge"></canvas>
                        <div class="gauge-label">Current Sound Level</div>
                        <div class="gauge-value" id="currentSound">- dB</div>
                    </div>
                    <div class="gauge-wrapper">
                        <canvas id="statusGauge"></canvas>
                        <div class="gauge-label">Status</div>
                        <div class="gauge-value" id="currentStatus">-</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card">
                <h2>Temperature Gauge</h2>
                <div class="gauge-container">
                    <div class="gauge-wrapper">
                        <canvas id="tempGauge"></canvas>
                        <div class="gauge-label">Current Temperature</div>
                        <div class="gauge-value" id="currentTemp">- °C</div>
                    </div>
                    <div class="gauge-wrapper">
                        <canvas id="tempStatusGauge"></canvas>
                        <div class="gauge-label">Status</div>
                        <div class="gauge-value" id="currentTempStatus">-</div>
                    </div>
                </div>
            </div>
        </div>

       
    </div>

    <script>
        // Global variables
        let soundData = [];
        let tempData = [];
        let soundChart, tempChart;
        let soundGauge, statusGauge, tempGauge, tempStatusGauge;
        let currentReading = 0;
        let totalReadings = 0;
        let updateInterval = 500; // Update every 500ms
        let animationSpeed = 1;

        
        // Fetch sensor data from the server
        function fetchSensorData() {
            fetch('/api/sensor-data/')
                .then(response => response.json())
                .then(data => {
                    soundData = data.sound_data;
                    tempData = data.temp_data;
                    pressureData = data.pressure_data; // Make sure to handle pressure data too
                    
                    // Update stats displays
                    updateStatistics(data.sound_stats, data.temp_stats, data.pressure_stats);
                    
                    // Update totalReadings
                    totalReadings = Math.max(soundData.length, tempData.length, pressureData ? pressureData.length : 0);
                    
                    // If this is the first fetch, start the simulation
                    if (currentReading === 0) {
                        startDataSimulation();
                    }
                })
                .catch(error => {
                    console.error('Error fetching sensor data:', error);
                });
        }
        window.addEventListener('DOMContentLoaded', () => {
            initializeCharts();
            initializeGauges();
            initializeModeSwitching();
            
            // Initial fetch
            fetchSensorData();
            
            // Set up periodic refreshing (every 30 seconds to match your backend)
            setInterval(fetchSensorData, 30000);
        });

        // Initialize charts
        function initializeCharts() {
            // Sound chart
            const soundCtx = document.getElementById('soundChart').getContext('2d');
            soundChart = new Chart(soundCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sound Level (dB)',
                        data: [],
                        borderColor: 'rgba(255, 0, 128, 1)',
                        backgroundColor: 'rgba(255, 0, 128, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 400
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#999'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#999'
                            }
                        }
                    }
                }
            });

            // Temperature chart
            const tempCtx = document.getElementById('tempChart').getContext('2d');
            tempChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: [],
                        borderColor: 'rgba(0, 128, 255, 1)',
                        backgroundColor: 'rgba(0, 128, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 400
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#999'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#999'
                            }
                        }
                    }
                }
            });
        }

        // Initialize gauges
        function initializeGauges() {
            // Sound level gauge
            const soundGaugeElement = document.getElementById('soundGauge');
            soundGauge = new Gauge(soundGaugeElement).setOptions({
                angle: 0.15,
                lineWidth: 0.44,
                radiusScale: 1,
                pointer: {
                    length: 0.6,
                    strokeWidth: 0.035,
                    color: '#fff'
                },
                limitMax: false,
                limitMin: false,
                colorStart: '#6FADCF',
                colorStop: '#FF00FF',
                strokeColor: '#1a1a2e',
                generateGradient: true,
                highDpiSupport: true,
                staticZones: [
                    { strokeStyle: "#30B32D", min: 0, max: 30 },
                    { strokeStyle: "#FFDD00", min: 30, max: 50 },
                    { strokeStyle: "#F03E3E", min: 50, max: 80 }
                ],
            });
            soundGauge.maxValue = 80;
            soundGauge.setMinValue(0);
            soundGauge.animationSpeed = 32;
            soundGauge.set(0);

            // Status gauge
            const statusGaugeElement = document.getElementById('statusGauge');
            statusGauge = new Gauge(statusGaugeElement).setOptions({
                angle: 0.15,
                lineWidth: 0.44,
                radiusScale: 1,
                pointer: {
                    length: 0.6,
                    strokeWidth: 0.035,
                    color: '#fff'
                },
                limitMax: false,
                limitMin: false,
                colorStart: '#6FADCF',
                colorStop: '#FF00FF',
                strokeColor: '#1a1a2e',
                generateGradient: true,
                highDpiSupport: true,
                staticZones: [
                    { strokeStyle: "#30B32D", min: 0, max: 1 },
                    { strokeStyle: "#FFDD00", min: 1, max: 2 },
                    { strokeStyle: "#F03E3E", min: 2, max: 3 }
                ],
            });
            statusGauge.maxValue = 3;
            statusGauge.setMinValue(0);
            statusGauge.animationSpeed = 32;
            statusGauge.set(0);

            // Temperature gauge
            const tempGaugeElement = document.getElementById('tempGauge');
            tempGauge = new Gauge(tempGaugeElement).setOptions({
                angle: 0.15,
                lineWidth: 0.44,
                radiusScale: 1,
                pointer: {
                    length: 0.6,
                    strokeWidth: 0.035,
                    color: '#fff'
                },
                limitMax: false,
                limitMin: false,
                colorStart: '#6FADCF',
                colorStop: '#8E44AD',
                strokeColor: '#1a1a2e',
                generateGradient: true,
                highDpiSupport: true,
                staticZones: [
                    { strokeStyle: "#F03E3E", min: -20, max: 0 },
                    { strokeStyle: "#30B32D", min: 0, max: 30 },
                    { strokeStyle: "#F03E3E", min: 30, max: 50 }
                ],
            });
            tempGauge.maxValue = 50;
            tempGauge.setMinValue(-20);
            tempGauge.animationSpeed = 32;
            tempGauge.set(0);

            // Temperature status gauge
            const tempStatusGaugeElement = document.getElementById('tempStatusGauge');
            tempStatusGauge = new Gauge(tempStatusGaugeElement).setOptions({
                angle: 0.15,
                lineWidth: 0.44,
                radiusScale: 1,
                pointer: {
                    length: 0.6,
                    strokeWidth: 0.035,
                    color: '#fff'
                },
                limitMax: false,
                limitMin: false,
                colorStart: '#6FADCF',
                colorStop: '#8E44AD',
                strokeColor: '#1a1a2e',
                generateGradient: true,
                highDpiSupport: true,
                staticZones: [
                    { strokeStyle: "#F03E3E", min: 0, max: 1 },
                    { strokeStyle: "#30B32D", min: 1, max: 2 },
                    { strokeStyle: "#F03E3E", min: 2, max: 3 }
                ],
            });
            tempStatusGauge.maxValue = 3;
            tempStatusGauge.setMinValue(0);
            tempStatusGauge.animationSpeed = 32;
            tempStatusGauge.set(0);
        }

        // Initialize mode switching
        function initializeModeSwitching() {
            const buttons = document.querySelectorAll('.mode-button');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    
                    const mode = button.getAttribute('data-mode');
                    switch(mode) {
                        case 'silent':
                            updateInterval = 1000;
                            animationSpeed = 0.5;
                            break;
                        case 'performance':
                            updateInterval = 500;
                            animationSpeed = 1;
                            break;
                        case 'turbo':
                            updateInterval = 200;
                            animationSpeed = 2;
                            break;
                        case 'manual':
                            updateInterval = 700;
                            animationSpeed = 0.75;
                            break;
                    }
                });
            });
        }

        // Update statistics displays
        function updateStatistics(soundStats, tempStats) {
            // Sound stats
            document.getElementById('avgSound').textContent = soundStats.avg.toFixed(2) + ' dB';
            document.getElementById('maxSound').textContent = soundStats.max.toFixed(2) + ' dB';
            document.getElementById('humanActivity').textContent = soundStats.human_activity_count;
            document.getElementById('predatorActivity').textContent = soundStats.predator_activity_count;
            
            // Temperature stats
            document.getElementById('avgTemp').textContent = tempStats.avg.toFixed(2) + ' °C';
            document.getElementById('minTemp').textContent = tempStats.min.toFixed(2) + ' °C';
            document.getElementById('maxTemp').textContent = tempStats.max.toFixed(2) + ' °C';
            document.getElementById('frostWarnings').textContent = tempStats.frost_warning_count;
        }
        function startDataSimulation() {
            const maxPointsToShow = 20;
            
            const simulationTimer = setInterval(() => {
                if (currentReading >= totalReadings) {
                    // Restart the simulation
                    currentReading = 0;
                    clearInterval(simulationTimer);
                    setTimeout(() => startDataSimulation(), 2000);
                    return;
                }

                // Get sound data for the current reading
                if (currentReading < soundData.length) {
                    const soundEntry = soundData[currentReading];
                    
                    // Update sound chart
                    if (soundChart.data.labels.length >= maxPointsToShow) {
                        soundChart.data.labels.shift();
                        soundChart.data.datasets[0].data.shift();
                    }

                    soundChart.data.labels.push(`Reading ${currentReading + 1}`);
                    soundChart.data.datasets[0].data.push(soundEntry.value);
                    soundChart.update();

                    // Update sound gauges
                    soundGauge.set(soundEntry.value);
                    statusGauge.set(soundEntry.status); // status is assumed to be numeric: 0 (normal), 1 (warning), 2 (alert)
                }

                // Get temperature data for the current reading
                if (currentReading < tempData.length) {
                    const tempEntry = tempData[currentReading];

                    // Update temp chart
                    if (tempChart.data.labels.length >= maxPointsToShow) {
                        tempChart.data.labels.shift();
                        tempChart.data.datasets[0].data.shift();
                    }

                    tempChart.data.labels.push(`Reading ${currentReading + 1}`);
                    tempChart.data.datasets[0].data.push(tempEntry.value);
                    tempChart.update();

                    // Update temp gauges
                    tempGauge.set(tempEntry.value);
                    tempStatusGauge.set(tempEntry.status); // status is assumed to be numeric: 0 (cold alert), 1 (normal), 2 (heat alert)
                }

                currentReading++;
            }, updateInterval / animationSpeed);
        }

        // Start data simulation
        function startDataSimulation() {
            const maxPointsToShow = 20;
            
            const simulationTimer = setInterval(() => {
                if (currentReading >= totalReadings) {
                    // Restart the simulation
                    currentReading = 0;
                    clearInterval(simulationTimer);
                    setTimeout(() => startDataSimulation(), 2000);
                    return;
                }
                
                // Get sound data for the current reading
                if (currentReading < soundData.length) {
                    const soundEntry = soundData[currentReading];
                    
                    // Update sound chart
                    if (soundChart.data.labels.length >= maxPointsToShow) {
                        soundChart.data.labels.shift();
                        soundChart.data.datasets[0].data.shift();
                    }
                    
                    soundChart.data.labels.push(`Reading ${soundEntry.reading}`);
                    soundChart.data.datasets[0].data.push(soundEntry.value);
                    soundChart.update();
                    
                    // Update sound gauge
                    soundGauge.set(soundEntry.value);
                    document.getElementById('currentSound').textContent = `${soundEntry.value.toFixed(2)} dB`;
                    
                    // Update status gauge
                    let statusValue = 0;
                    if (soundEntry.status === 'Normal') {
                        statusValue = 0.5;
                        document.getElementById('currentStatus').textContent = 'Normal';
                        document.getElementById('currentStatus').className = 'gauge-value status-normal';
                    } else if (soundEntry.status === 'Human Activity Detected') {
                        statusValue = 1.5;
                        document.getElementById('currentStatus').textContent = 'Human Activity';
                        document.getElementById('currentStatus').className = 'gauge-value status-warning';
                    } else if (soundEntry.status === 'Predator Activity Detected') {
                        statusValue = 2.5;
                        document.getElementById('currentStatus').textContent = 'Predator Activity!';
                        document.getElementById('currentStatus').className = 'gauge-value status-alert animate-pulse';
                        
                        // Show predator alert
                        const alertElement = document.getElementById('predatorAlert');
                        alertElement.classList.add('show');
                        document.getElementById('alertTime').textContent = new Date().toLocaleTimeString();
                        
                        // Hide alert after 5 seconds
                        setTimeout(() => {
                            alertElement.classList.remove('show');
                        }, 5000);
                    }
                    statusGauge.set(statusValue);
                }
                
                // Get temperature data (using mod to cycle through the smaller temp dataset)
                const tempIndex = currentReading % tempData.length;
                const tempEntry = tempData[tempIndex];
                
                // Update temperature chart
                if (tempChart.data.labels.length >= maxPointsToShow) {
                    tempChart.data.labels.shift();
                    tempChart.data.datasets[0].data.shift();
                }
                
                tempChart.data.labels.push(`Reading ${tempEntry.reading}`);
                tempChart.data.datasets[0].data.push(tempEntry.value);
                tempChart.update();
                
                // Update temperature gauge
                tempGauge.set(tempEntry.value);
                document.getElementById('currentTemp').textContent = `${tempEntry.value.toFixed(2)} °C`;
                
                // Update temperature status gauge
                let tempStatusValue = 0;
                if (tempEntry.status === 'Normal') {
                    tempStatusValue = 1.5;
                    document.getElementById('currentTempStatus').textContent = 'Normal';
                    document.getElementById('currentTempStatus').className = 'gauge-value status-normal';
                } else if (tempEntry.status === 'Frost Warning') {
                    tempStatusValue = 0.5;
                    document.getElementById('currentTempStatus').textContent = 'Frost Warning';
                    document.getElementById('currentTempStatus').className = 'gauge-value status-alert';
                }
                tempStatusGauge.set(tempStatusValue);
                
                // Increment reading counter
                currentReading += 1 * animationSpeed;
                
            }, updateInterval);
        }
    </script>
</body>
</html>